# Example Nginx configuration for a service protected by RAuth
# This file shows how to use the 'auth_request' module to secure any backend.

server {
    listen 80;
    server_name myapp.yourdomain.com;

    # 1. Main location block for your application
    location / {
        # This tells Nginx to check with RAuth before allowing the request
        auth_request /rauth-verify;

        # If RAuth returns 401 (Unauthorized), redirect the user to the login page
        error_page 401 = @error401;

        # Optional: Pass the authenticated username to your backend application
        # The Auth service can be configured to return headers which Nginx can capture
        auth_request_set $auth_user $upstream_http_x_user;
        proxy_set_header X-Remote-User $auth_user;

        # Normal proxy configuration for your app
        proxy_pass http://your_backend_service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 2. Internal endpoint used by Nginx to communicate with RAuth
    location = /rauth-verify {
        internal;
        # Use the internal Docker service name or the public URL of your RAuth instance
        proxy_pass http://rauth-auth-service/rauthvalidate;
        
        # Optional: Require a specific group for this location
        # proxy_set_header X-RAuth-Required-Group "admins";

        # Don't send the original request body to the auth service
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        
        # Pass the original URL so the auth service knows where to redirect after login
        proxy_set_header X-Original-URL $scheme://$http_host$request_uri;
        
        # Pass cookies (where the auth token is stored)
        proxy_set_header Cookie $http_cookie;
    }

    # 3. Redirect to the RAuth login page when the user is not authenticated
    location @error401 {
        # Redirect to the RAuth login page with the current URL as the return path
        return 302 https://auth.yourdomain.com/rauthlogin?rd=$scheme://$http_host$request_uri;
    }
}
