# Example Nginx configuration for a service protected by RAuth
# This file shows how to use the 'auth_request' module to secure any backend.

server {
    listen 80;
    server_name myapp.yourdomain.com;

    # 1. Main location block for your application
    location / {
        # This tells Nginx to check with RAuth before allowing the request
        auth_request /rauth-verify;

        # Propagate the session refresh cookie if RAuth provides one
        auth_request_set $auth_cookie $upstream_http_set_cookie;
        add_header Set-Cookie $auth_cookie;

        # Capture the authenticated user from RAuth headers
        auth_request_set $auth_user $upstream_http_x_rauth_user;
        auth_request_set $auth_groups $upstream_http_x_rauth_groups;
        auth_request_set $auth_admin $upstream_http_x_rauth_admin;
        
        proxy_set_header X-Remote-User $auth_user;
        proxy_set_header X-Remote-Groups $auth_groups;
        proxy_set_header X-Remote-Admin $auth_admin;

        # If RAuth returns 401 (Unauthorized), redirect the user to the login page
        error_page 401 = @error401;

        # Normal proxy configuration for your app
        proxy_pass http://your_backend_service:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 2. Internal endpoint used by Nginx to communicate with RAuth
    location = /rauth-verify {
        internal;
        # Use the internal Docker service name or the public URL of your RAuth instance
        proxy_pass http://rauth-app:80/rauthvalidate;

        # Don't send the original request body to the auth service
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        
        # Pass the original URL and IP for validation logic
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Pass cookies (where the auth token is stored)
        proxy_set_header Cookie $http_cookie;
    }

    # 3. Redirect to the RAuth login page when the user is not authenticated
    location @error401 {
        # Redirect to the RAuth login page with the current URL as the return path
        # Ensure 'auth.yourdomain.com' is replaced with your actual RAuth domain
        # It is highly recommended to use HTTPS for RAuth.
        return 302 https://auth.yourdomain.com/rauthlogin?rd=$scheme://$http_host$request_uri;
    }
}
