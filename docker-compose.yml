services:
  rauth-auth-service:
    container_name: rauth-auth-service
    build: .
    image: ghcr.io/${GITHUB_REPOSITORY_OWNER:-arumes31}/rauth-auth:latest
    ports:
      - "${AUTH_PORT:-5980}:80"
    environment:
      - REDIS_HOST=rauth-auth-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - INITIAL_USER=${INITIAL_USER:-admin}
      - INITIAL_PASSWORD=${INITIAL_PASSWORD}
      - INITIAL_EMAIL=${INITIAL_EMAIL:-admin@example.com}
      - INITIAL_2FA_SECRET=${INITIAL_2FA_SECRET}
      - TOKEN_VALIDITY_MINUTES=${TOKEN_VALIDITY_MINUTES:-2880}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - SERVER_SECRET=${SERVER_SECRET}
      - TZ=${TZ:-UTC}
      - MAXMIND_ACCOUNT_ID=${MAXMIND_ACCOUNT_ID}
      - MAXMIND_LICENSE_KEY=${MAXMIND_LICENSE_KEY}
      - MAXMIND_DB_PATH=/app/geoip/GeoLite2-Country.mmdb
      - GEOIP_EDITION_IDS=${GEOIP_EDITION_IDS:-GeoLite2-Country}
      - GEOIP_DATABASE_DIRECTORY=/app/geoip
      - WEBAUTHN_ORIGINS=${WEBAUTHN_ORIGINS}
      - PUBLIC_URL=${PUBLIC_URL}
      - PWD_MIN_LENGTH=${PWD_MIN_LENGTH:-8}
      - PWD_REQUIRE_UPPER=${PWD_REQUIRE_UPPER:-true}
      - PWD_REQUIRE_LOWER=${PWD_REQUIRE_LOWER:-true}
      - PWD_REQUIRE_NUMBER=${PWD_REQUIRE_NUMBER:-true}
      - PWD_REQUIRE_SPECIAL=${PWD_REQUIRE_SPECIAL:-true}
      - METRICS_ALLOWED_IPS=${METRICS_ALLOWED_IPS}
      - RATE_LIMIT_LOGIN_MAX=${RATE_LIMIT_LOGIN_MAX:-10}
      - RATE_LIMIT_LOGIN_DECAY=${RATE_LIMIT_LOGIN_DECAY:-300}
      - RATE_LIMIT_REG_MAX=${RATE_LIMIT_REG_MAX:-10}
      - RATE_LIMIT_REG_DECAY=${RATE_LIMIT_REG_DECAY:-300}
      - RATE_LIMIT_VALIDATE_MAX=${RATE_LIMIT_VALIDATE_MAX:-1000}
      - RATE_LIMIT_VALIDATE_DECAY=${RATE_LIMIT_VALIDATE_DECAY:-60}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM}
    depends_on:
      - rauth-auth-redis
    volumes:
      - ./geoip-data:/app/geoip
    networks:
      - auth-network

  rauth-auth-redis:
    image: redis:8.0-alpine
    container_name: rauth-auth-redis
    hostname: rauth-auth-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./redis-data:/data
    networks:
      - auth-network

networks:
  auth-network:
    driver: bridge