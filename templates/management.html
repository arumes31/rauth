{{define "management.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management | RAuth</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/modern.css" rel="stylesheet">
</head>
<body class="bg-light-animated">
        <div class="scanlines"></div>
        
        <!-- Command Palette Modal -->
        <div class="modal fade" id="commandPalette" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content command-palette">
                    <div class="modal-body p-0">
                        <input type="text" id="commandInput" class="form-control command-input" placeholder="Type a command (e.g., 'sessions', 'audit', 'new user')..." autocomplete="off">
                        <div id="commandResults" class="py-2">
                            <!-- Options will be injected here -->
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-2 opacity-50 small">
                        <span class="me-3"><kbd>↑↓</kbd> to navigate</span>
                        <span class="me-3"><kbd>Enter</kbd> to select</span>
                        <span><kbd>Esc</kbd> to close</span>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Toast Container -->
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast matrix-toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-transparent border-0 text-primary">
                <i class="bi bi-shield-check me-2"></i>
                <strong class="me-auto">SECURE OPS NOTIFICATION</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body small fw-bold" id="toastMessage">
                Administrative operation successful.
            </div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand fs-3" href="#">RAuth</a>
            <div class="d-flex align-items-center">
                <a href="/rauthprofile" class="btn btn-sm btn-link text-decoration-none text-muted me-3">
                    <i class="bi bi-person-circle me-1"></i> My Profile
                </a>
                <span class="text-muted small me-4">Admin: <strong>{{.username}}</strong></span>
                <form method="POST" action="/logout">
                    <input type="hidden" name="csrf" value="{{.csrf}}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-box-arrow-right"></i>
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mt-5 animate-fade-in">
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
                    <i class="bi bi-activity me-2"></i> Active Sessions
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                    <i class="bi bi-people me-2"></i> User Directory
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab">
                    <i class="bi bi-journal-text me-2"></i> Audit Logs
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="invites-tab" data-bs-toggle="tab" data-bs-target="#invites" type="button" role="tab">
                    <i class="bi bi-envelope-plus me-2"></i> Invitations
                </button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            <!-- Sessions Tab -->
            <div class="tab-pane fade show active" id="sessions" role="tabpanel">
                <div class="card shadow-sm border-0">
                    <div class="card-header py-3">
                        <h6 class="mb-0 fw-bold">Active Session Monitor</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">User</th>
                                        <th>Location</th>
                                        <th>Device / User Agent</th>
                                        <th>Started</th>
                                        <th>Expires In</th>
                                        <th class="text-end pe-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .sessions}}
                                    <tr class="align-middle">
                                        <td class="ps-4">
                                            <div class="fw-bold text-primary">{{index . "username"}}</div>
                                            <div class="extra-small text-muted">{{index . "ip"}}</div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">
                                                {{index . "country"}}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="fs-5 me-2 text-primary opacity-50">
                                                    <i class="bi {{index . "device_icon"}}"></i>
                                                </div>
                                                <div class="extra-small text-truncate text-muted" style="max-width: 200px;" title="{{index . "user_agent"}}">
                                                    {{index . "friendly_ua"}}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-muted small">
                                            {{index . "created_at" | formatTime}}
                                        </td>
                                        <td>
                                            <span class="text-success small fw-bold">
                                                <i class="bi bi-clock-history me-1"></i>
                                                {{index . "ttl" | formatSeconds}}
                                            </span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <form method="POST" action="/rauthmgmt/session/invalidate" onsubmit="return confirm('Invalidate this session?')">
                                                <input type="hidden" name="csrf" value="{{$.csrf}}">
                                                <input type="hidden" name="token" value="{{index . "token"}}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Terminate Session">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {{else}}
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted">No active sessions found</td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel">
                <div class="card shadow-sm border-0">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">User Access Management</h6>
                        <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#createUserModal">
                            <i class="bi bi-person-plus me-1"></i> Add User
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th class="text-end pe-4">Manage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .users}}
                                    <tr class="align-middle">
                                        <td class="ps-4"><strong>{{.Username}}</strong></td>
                                        <td>{{.Email}}</td>
                                        <td>
                                            {{if eq .IsAdmin "1"}}
                                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25">Administrator</span>
                                            {{else}}
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25">User</span>
                                            {{end}}
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary border-0" 
                                                        onclick="openEditModal('{{.Username}}', '{{.Email}}')" 
                                                        title="Edit User">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <form method="POST" action="/rauthmgmt/user/delete" onsubmit="return confirm('Are you sure you want to delete this user?')">
                                                    <input type="hidden" name="csrf" value="{{$.csrf}}">
                                                    <input type="hidden" name="username" value="{{.Username}}">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Delete User"><i class="bi bi-person-x"></i></button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Tab -->
            <div class="tab-pane fade" id="audit" role="tabpanel">
                <div class="card shadow-sm border-0">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">System Audit Logs</h6>
                        <div class="input-group input-group-sm" style="max-width: 300px;">
                            <span class="input-group-text bg-transparent border-end-0 text-muted"><i class="bi bi-search"></i></span>
                            <input type="text" id="auditSearch" class="form-control border-start-0" placeholder="Filter events, users, or IPs...">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="auditTable">
                                <thead>
                                    <tr>
                                        <th class="ps-4">Timestamp</th>
                                        <th>Event</th>
                                        <th>Context</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{range .logs}}
                                    <tr class="align-middle audit-row">
                                        <td class="ps-4 text-muted small">{{.Timestamp | formatTime}}</td>
                                        <td><span class="{{.Action | statusColor}} extra-small fw-bold text-uppercase" style="letter-spacing: 0.5px;">{{.Action}}</span></td>
                                        <td>
                                            <div class="small fw-bold text-primary"><i class="bi bi-person me-1"></i> {{.Username}}</div>
                                            <div class="extra-small text-muted">
                                                <i class="bi bi-hdd-network me-1"></i> {{.IP}}
                                                {{if .Details.country}}
                                                    <span class="ms-2 badge bg-secondary bg-opacity-25 text-secondary border border-secondary border-opacity-25">{{.Details.country}}</span>
                                                {{end}}
                                            </div>
                                        </td>
                                    </tr>
                                    {{else}}
                                    <tr>
                                        <td colspan="3" class="text-center py-5 text-muted">No audit logs found</td>
                                    </tr>
                                    {{end}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invitations Tab -->
            <div class="tab-pane fade" id="invites" role="tabpanel">
                <div class="card shadow-sm border-0">
                    <div class="card-header py-3">
                        <h6 class="mb-0 fw-bold">Secure Invitation System</h6>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-muted small mb-4">
                            Instead of creating a password for the user, generate a secure invitation link. 
                            The user will be able to set their own username and password upon redemption.
                        </p>
                        <form id="inviteForm" class="row g-3">
                            <input type="hidden" name="csrf" value="{{.csrf}}">
                            <div class="col-md-8">
                                <label class="form-label small fw-bold text-muted">Recipient Email Address</label>
                                <input type="email" name="email" id="inviteEmail" class="form-control" placeholder="user@example.com" required>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-danger w-100 py-2 fw-bold">Generate Link</button>
                            </div>
                        </form>

                        <div id="inviteResult" class="mt-4 d-none">
                            <label class="form-label small fw-bold text-success">Invitation Link Generated</label>
                            <div class="input-group">
                                <input type="text" id="inviteUrl" class="form-control bg-light" readonly>
                                <button class="btn btn-outline-success" type="button" onclick="copyInviteUrl()">
                                    <i class="bi bi-clipboard me-1"></i> Copy
                                </button>
                            </div>
                            <div class="extra-small text-muted mt-2">
                                <i class="bi bi-info-circle me-1"></i> This link will expire in 24 hours.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <form method="POST" action="/rauthmgmt/user/create">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold">New Identity</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <input type="hidden" name="csrf" value="{{.csrf}}">
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Username</label>
                            <input type="text" name="new_username" class="form-control" required placeholder="e.g. john.doe">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Password</label>
                            <input type="password" name="new_password" class="form-control" required placeholder="••••••••">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted">Email</label>
                            <input type="email" name="new_email" class="form-control" placeholder="user@example.com">
                        </div>
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" name="is_admin" id="isAdminCheck">
                            <label class="form-check-label small fw-bold text-muted" for="isAdminCheck">Grant administrative privileges</label>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="submit" class="btn btn-danger w-100 py-2 fw-bold">Create Account</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Edit User: <span id="editModalUsername"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Update Email Section -->
                    <form method="POST" action="/rauthmgmt/user/update-email" class="mb-4">
                        <input type="hidden" name="csrf" value="{{.csrf}}">
                        <input type="hidden" name="username" id="emailUsernameInput">
                        <label class="form-label small fw-bold text-muted">Update Email Address</label>
                        <div class="input-group mb-3">
                            <input type="email" name="new_email" id="emailInput" class="form-control" placeholder="new.email@example.com" required>
                            <button class="btn btn-outline-danger" type="submit">Save</button>
                        </div>
                    </form>

                    <hr class="border-secondary opacity-25 my-4">

                    <!-- Change Password Section -->
                    <form method="POST" action="/rauthmgmt/user/change-password" class="mb-4">
                        <input type="hidden" name="csrf" value="{{.csrf}}">
                        <input type="hidden" name="username" id="passwordUsernameInput">
                        <label class="form-label small fw-bold text-muted">Change Password</label>
                        <div class="input-group mb-3">
                            <input type="password" name="new_password" class="form-control" placeholder="New Password" required>
                            <button class="btn btn-outline-danger" type="submit">Update</button>
                        </div>
                    </form>

                    <hr class="border-secondary opacity-25 my-4">

                    <!-- Reset 2FA Section -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <label class="form-label small fw-bold text-muted mb-0">Two-Factor Authentication</label>
                            <p class="extra-small text-muted mb-0">Clear the 2FA secret to allow user re-setup</p>
                        </div>
                        <form method="POST" action="/rauthmgmt/user/reset-2fa" onsubmit="return confirm('Reset 2FA for this user?')">
                            <input type="hidden" name="csrf" value="{{.csrf}}">
                            <input type="hidden" name="username" id="reset2faUsernameInput">
                            <button type="submit" class="btn btn-sm btn-outline-warning">Reset 2FA</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        
        function openEditModal(username, email) {
            document.getElementById('editModalUsername').textContent = username;
            document.getElementById('passwordUsernameInput').value = username;
            document.getElementById('emailUsernameInput').value = username;
            document.getElementById('emailInput').value = email;
            document.getElementById('reset2faUsernameInput').value = username;
            editUserModal.show();
        }

        // Command Palette Logic
        const commands = [
            { name: 'Monitor: Active Sessions', cmd: 'sessions', action: () => document.getElementById('sessions-tab').click() },
            { name: 'Directory: User Management', cmd: 'users', action: () => document.getElementById('users-tab').click() },
            { name: 'Security: Audit Logs', cmd: 'audit', action: () => document.getElementById('audit-tab').click() },
            { name: 'Access: Invitations', cmd: 'invites', action: () => document.getElementById('invites-tab').click() },
            { name: 'Action: Create New User', cmd: 'new', action: () => new bootstrap.Modal(document.getElementById('createUserModal')).show() },
            { name: 'Nav: My Profile', cmd: 'profile', action: () => window.location.href = '/rauthprofile' },
            { name: 'Nav: Logout', cmd: 'logout', action: () => document.querySelector('form[action="/logout"]').submit() }
        ];

        let currentFocus = -1;
        const cpModalElement = document.getElementById('commandPalette');
        const cpModal = new bootstrap.Modal(cpModalElement);

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                cpModal.show();
            }
            if (e.key === '/') {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    cpModal.show();
                }
            }
        });

        cpModalElement.addEventListener('shown.bs.modal', () => {
            document.getElementById('commandInput').focus();
            renderCommands('');
        });

        document.getElementById('commandInput').addEventListener('input', (e) => {
            renderCommands(e.target.value);
        });

        document.getElementById('commandInput').addEventListener('keydown', (e) => {
            const items = document.querySelectorAll('.command-option');
            if (e.key === 'ArrowDown') {
                currentFocus++;
                addActive(items);
            } else if (e.key === 'ArrowUp') {
                currentFocus--;
                addActive(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocus > -1 && items[currentFocus]) {
                    items[currentFocus].click();
                }
            }
        });

        function renderCommands(filter) {
            const results = document.getElementById('commandResults');
            results.innerHTML = '';
            const filtered = commands.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()) || c.cmd.includes(filter.toLowerCase()));
            
            filtered.forEach((c, idx) => {
                const div = document.createElement('div');
                div.className = 'command-option d-flex justify-content-between align-items-center';
                div.innerHTML = `<span><i class="bi bi-chevron-right me-2 opacity-50"></i>${c.name}</span> <span class="command-shortcut">/${c.cmd}</span>`;
                div.onclick = () => {
                    c.action();
                    cpModal.hide();
                };
                results.appendChild(div);
            });
            currentFocus = -1;
        }

        function addActive(items) {
            if (!items) return false;
            items.forEach(i => i.classList.remove('active'));
            if (currentFocus >= items.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = items.length - 1;
            items[currentFocus].classList.add('active');
            items[currentFocus].scrollIntoView({ block: 'nearest' });
        }

        // Handle success messages
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                const success = urlParams.get('success');
                const messages = {
                    '2fa_reset': 'Two-factor authentication has been reset for the user.',
                    'password_changed': 'User password has been updated successfully.',
                    'email_updated': 'User email address has been updated.',
                    'user_created': 'New identity created in the system.',
                    'user_deleted': 'User has been purged from the directory.'
                };
                
                const msg = messages[success] || 'Administrative action completed.';
                document.getElementById('toastMessage').textContent = msg;
                const toast = new bootstrap.Toast(document.getElementById('successToast'));
                toast.show();
                
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        document.getElementById('inviteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            try {
                const response = await fetch('/rauthmgmt/invite/create', {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('inviteUrl').value = data.url;
                    document.getElementById('inviteResult').classList.remove('d-none');
                } else {
                    alert("Failed to generate invitation link.");
                }
            } catch (err) {
                console.error(err);
                alert("An error occurred.");
            }
        }

        // Audit Search Logic
        document.getElementById('auditSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.audit-row');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });

        function copyInviteUrl() {
            const urlInput = document.getElementById('inviteUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(urlInput.value);
            
            const btn = event.currentTarget;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check2"></i> Copied!';
            btn.className = "btn btn-success";
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.className = "btn btn-outline-success";
            }, 2000);
        }
    </script>
</body>
</html>
{{end}}