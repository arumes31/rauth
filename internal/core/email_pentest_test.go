package core

import (
	"html"
	"strings"
	"testing"
	"github.com/stretchr/testify/assert"
)

func TestEmailHeaderInjection_Fixed(t *testing.T) {
	maliciousSubject := "Hello\r\nBcc: spy@evil.com"
	sanitized := sanitizeEmailHeader(maliciousSubject)
	
	assert.False(t, strings.Contains(sanitized, "\r"), "Carriage return not removed!")
	assert.False(t, strings.Contains(sanitized, "\n"), "Newline not removed!")
	assert.True(t, strings.Contains(sanitized, "Bcc:"), "Content should remain but sanitized")
}

func TestEmailHTMLInjection_Fixed(t *testing.T) {
	maliciousUsername := "User<img src=x onerror=alert(1)>"
	escaped := html.EscapeString(maliciousUsername)
	
	assert.False(t, strings.Contains(escaped, "<img"), "HTML tags not escaped!")
	assert.True(t, strings.Contains(escaped, "&lt;img"), "HTML tags should be entity-encoded")
}