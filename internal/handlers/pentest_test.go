package handlers

import (
	"net/http"
	"net/http/httptest"
	"rauth/internal/core"
	"testing"

	"github.com/labstack/echo/v4"
	"github.com/stretchr/testify/assert"
)

func TestPentest_OpenRedirect_Fixed(t *testing.T) {
	cfg := &core.Config{
		CookieDomains: []string{"example.com"},
		AllowedHosts:  []string{"localhost"},
	}

	t.Run("Safe redirect to subdomain", func(t *testing.T) {
		assert.True(t, cfg.IsAllowedHost("app.example.com"))
	})

	t.Run("Safe redirect to exact domain", func(t *testing.T) {
		assert.True(t, cfg.IsAllowedHost("example.com"))
	})

	t.Run("FIXED: Suffix abuse is now rejected", func(t *testing.T) {
		assert.False(t, cfg.IsAllowedHost("evil-example.com"), "Suffix match should be rejected if no dot prefix")
	})
}

func TestPentest_TokenEncryption(t *testing.T) {
	secret := "32-byte-long-secret-for-aes-gcm!!"
	token := "sensitive-token-123"
	
	encrypted, err := core.EncryptToken(token, secret)
	assert.NoError(t, err)
	assert.NotEqual(t, token, encrypted)
	
	decrypted, err := core.DecryptToken(encrypted, secret)
	assert.NoError(t, err)
	assert.Equal(t, token, decrypted)
}

func TestPentest_RateLimitBypass(t *testing.T) {
	// Check if RealIP() can be spoofed if not behind a trusted proxy
	e := echo.New()
	req := httptest.NewRequest(http.MethodGet, "/", nil)
	req.Header.Set("X-Forwarded-For", "1.1.1.1")
	c := e.NewContext(req, nil)
	
	// If echo is not configured with trusted proxies, it might take X-Forwarded-For
	assert.Equal(t, "1.1.1.1", c.RealIP(), "RealIP() should return the forwarded IP if not hardened")
}

func TestPentest_SSRF_GeoIP(t *testing.T) {
	t.Run("IP validation in GetCountryCode", func(t *testing.T) {
		// Test behavior with invalid/malicious IP strings
		// GetCountryCode should ideally validate the IP before building the URL
	})
}

func TestPentest_Admin_Action_Session_Invalidation(t *testing.T) {
	// Vulnerability Check: When an admin changes a user's password or resets 2FA, 
	// the user's existing active sessions should be terminated to prevent 
	// continued access using compromised state or old credentials.
}

func TestPentest_CSRF_Protection_New_Routes(t *testing.T) {
	// Verify that /rauthmgmt/user/change-password and /rauthmgmt/user/reset-2fa 
	// are strictly protected by CSRF.
}
